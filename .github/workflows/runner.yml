name: Auto Bounty Hunter Runner
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  strike:
    runs-on: ubuntu-latest
    # üëá REQUIRED: This unlocks your 'Environment Secrets'
    environment: Autonomous Bounty Hunter env 
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install psycopg2-binary

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Build Contracts
        run: forge build --contracts onchain/contracts --force

      - name: Start Anvil & Deploy Contract
        run: |
          anvil --silent &
          sleep 5
          DEPLOY_LOG=$(forge create onchain/contracts/BountyBoard.sol:BountyBoard \
            --rpc-url http://127.0.0.1:8545 \
            --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80)
          
          ADDR=$(echo "$DEPLOY_LOG" | grep "Deployed to:" | awk '{print $3}')
          echo "DEPLOYED_ADDR=$ADDR" >> $GITHUB_ENV

      - name: Run Hunter Agent
        env:
          # All these come from Settings > Secrets and variables > Actions > Secrets (Environment tab)
          TRIAGE_MODEL: ${{ secrets.TRIAGE_MODEL }}
          PATCHER_MODEL: ${{ secrets.PATCHER_MODEL }}
          RPC_URL: http://127.0.0.1:8545
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          CONTRACT_ADDRESS: ${{ env.DEPLOYED_ADDR }}
          COMMITMENT_SALT: ${{ secrets.COMMITMENT_SALT }}
          ABI_PATH: ${{ secrets.ABI_PATH }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TARGET_REPO: ${{ secrets.TARGET_REPO }}
          ENVIRONMENT: production
          PYTHONPATH: .
        run: |
            # Clean Debug: Check if the secret is loaded
            echo "Verifying DATABASE_URL..."
            if [ -z "$DATABASE_URL" ]; then 
              echo "‚ùå ERROR: DATABASE_URL is still empty!"
              exit 1
            fi
            echo "‚úÖ Secret found (Length: ${#DATABASE_URL}). Starting Hunter Agent..."
            python main.py